if("undefined"==typeof Product)var Product={};Product.Bundle=Class.create(),Product.Bundle.prototype={initialize:function(config){if(this.config=config,config.defaultValues)for(var option in config.defaultValues)if(this.config.options[option].isMulti){for(var selected=new Array,i=0;i<config.defaultValues[option].length;i++)selected.push(config.defaultValues[option][i]);this.config.selected[option]=selected}else this.config.selected[option]=new Array(config.defaultValues[option]+"");this.reloadPrice()},changeSelection:function(selection){var parts=selection.id.split("-");if(this.config.options[parts[2]].isMulti){if(selected=new Array,"SELECT"==selection.tagName)for(var i=0;i<selection.options.length;i++)selection.options[i].selected&&""!=selection.options[i].value&&selected.push(selection.options[i].value);else if("INPUT"==selection.tagName){selector=parts[0]+"-"+parts[1]+"-"+parts[2],selections=$$("."+selector);for(var i=0;i<selections.length;i++)selections[i].checked&&""!=selections[i].value&&selected.push(selections[i].value)}this.config.selected[parts[2]]=selected}else{""!=selection.value?this.config.selected[parts[2]]=new Array(selection.value):this.config.selected[parts[2]]=new Array,this.populateQty(parts[2],selection.value);var tierPriceElement=$("bundle-option-"+parts[2]+"-tier-prices"),tierPriceHtml="";""!=selection.value&&1==this.config.options[parts[2]].selections[selection.value].customQty&&(tierPriceHtml=this.config.options[parts[2]].selections[selection.value].tierPriceHtml),tierPriceElement.update(tierPriceHtml)}this.reloadPrice()},reloadPrice:function(){var calculatedPrice=0,dispositionPrice=0,includeTaxPrice=0;for(var option in this.config.selected)if(this.config.options[option])for(var i=0;i<this.config.selected[option].length;i++){var prices=this.selectionPrice(option,this.config.selected[option][i]);calculatedPrice+=Number(prices[0]),dispositionPrice+=Number(prices[1]),includeTaxPrice+=Number(prices[2])}if(taxCalcMethod==CACL_TOTAL_BASE){var calculatedPriceFormatted=calculatedPrice.toFixed(10),includeTaxPriceFormatted=includeTaxPrice.toFixed(10),tax=includeTaxPriceFormatted-calculatedPriceFormatted;calculatedPrice=includeTaxPrice-Math.round(100*tax)/100}"0"==this.config.priceType&&(calculatedPrice=Math.round(100*calculatedPrice)/100,dispositionPrice=Math.round(100*dispositionPrice)/100,includeTaxPrice=Math.round(100*includeTaxPrice)/100);var event=$(document).fire("bundle:reload-price",{price:calculatedPrice,priceInclTax:includeTaxPrice,dispositionPrice:dispositionPrice,bundle:this});return event.noReloadPrice||(optionsPrice.specialTaxPrice="true",optionsPrice.changePrice("bundle",calculatedPrice),optionsPrice.changePrice("nontaxable",dispositionPrice),optionsPrice.changePrice("priceInclTax",includeTaxPrice),optionsPrice.reload()),calculatedPrice},selectionPrice:function(optionId,selectionId){if(""==selectionId||"none"==selectionId||"undefined"==typeof this.config.options[optionId].selections[selectionId])return 0;var tierPriceInclTax,tierPriceExclTax,qty=null;if(qty=1!=this.config.options[optionId].selections[selectionId].customQty||this.config.options[optionId].isMulti?this.config.options[optionId].selections[selectionId].qty:$("bundle-option-"+optionId+"-qty-input")?$("bundle-option-"+optionId+"-qty-input").value:1,"0"==this.config.priceType){price=this.config.options[optionId].selections[selectionId].price,tierPrice=this.config.options[optionId].selections[selectionId].tierPrice;for(var i=0;i<tierPrice.length;i++)Number(tierPrice[i].price_qty)<=qty&&Number(tierPrice[i].price)<=price&&(price=tierPrice[i].price,tierPriceInclTax=tierPrice[i].priceInclTax,tierPriceExclTax=tierPrice[i].priceExclTax)}else selection=this.config.options[optionId].selections[selectionId],"0"==selection.priceType?price=selection.priceValue:price=this.config.basePrice*selection.priceValue/100;var disposition=this.config.options[optionId].selections[selectionId].plusDisposition+this.config.options[optionId].selections[selectionId].minusDisposition;if(this.config.specialPrice&&(newPrice=price*this.config.specialPrice/100,price=Math.min(newPrice,price)),selection=this.config.options[optionId].selections[selectionId],void 0!==tierPriceInclTax&&void 0!==tierPriceExclTax?(priceInclTax=tierPriceInclTax,price=tierPriceExclTax):void 0!==selection.priceInclTax?(priceInclTax=selection.priceInclTax,price=void 0!==selection.priceExclTax?selection.priceExclTax:selection.price):priceInclTax=price,"1"==this.config.priceType||taxCalcMethod==CACL_TOTAL_BASE){var result=new Array(price*qty,disposition*qty,priceInclTax*qty);return result}if(taxCalcMethod==CACL_UNIT_BASE){price=(Math.round(100*price)/100).toString(),disposition=(Math.round(100*disposition)/100).toString(),priceInclTax=(Math.round(100*priceInclTax)/100).toString();var result=new Array(price*qty,disposition*qty,priceInclTax*qty);return result}price=(Math.round(price*qty*100)/100).toString(),disposition=(Math.round(disposition*qty*100)/100).toString(),priceInclTax=(Math.round(priceInclTax*qty*100)/100).toString();var result=new Array(price,disposition,priceInclTax);return result},populateQty:function(optionId,selectionId){return""==selectionId||"none"==selectionId?void this.showQtyInput(optionId,"0",!1):void(1==this.config.options[optionId].selections[selectionId].customQty?this.showQtyInput(optionId,this.config.options[optionId].selections[selectionId].qty,!0):this.showQtyInput(optionId,this.config.options[optionId].selections[selectionId].qty,!1))},showQtyInput:function(optionId,value,canEdit){elem=$("bundle-option-"+optionId+"-qty-input"),elem.value=value,elem.disabled=!canEdit,canEdit?elem.removeClassName("qty-disabled"):elem.addClassName("qty-disabled")},changeOptionQty:function(element,event){var checkQty=!0;"undefined"!=typeof event&&(8!=event.keyCode&&46!=event.keyCode||(checkQty=!1)),checkQty&&(0==Number(element.value)||isNaN(Number(element.value)))&&(element.value=1),parts=element.id.split("-"),optionId=parts[2],this.config.options[optionId].isMulti||(selectionId=this.config.selected[optionId][0],this.config.options[optionId].selections[selectionId].qty=1*element.value,this.reloadPrice())},validationCallback:function(elmId,result){if(void 0!=elmId&&void 0!=$(elmId)){var container=$(elmId).up("ul.options-list");"undefined"!=typeof container&&("failed"==result?(container.removeClassName("validation-passed"),container.addClassName("validation-failed")):(container.removeClassName("validation-failed"),container.addClassName("validation-passed")))}}};