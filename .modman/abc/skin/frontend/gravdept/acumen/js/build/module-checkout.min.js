Accordion=Class.create(),Accordion.prototype={initialize:function(elem,clickableEntity,checkAllow){this.container=$(elem),this.checkAllow=checkAllow||!1,this.disallowAccessToNextSections=!1,this.sections=$$("#"+elem+" .section"),this.currentSection=!1;var headers=$$("#"+elem+" .section "+clickableEntity);headers.each(function(header){Event.observe(header,"click",this.sectionClicked.bindAsEventListener(this))}.bind(this))},sectionClicked:function(event){this.openSection($(Event.element(event)).up(".section")),Event.stop(event)},openSection:function(section){var section=$(section);if((!this.checkAllow||Element.hasClassName(section,"allow"))&&section.id!=this.currentSection){this.closeExistingSection(),this.currentSection=section.id,$(this.currentSection).addClassName("active");var contents=Element.select(section,".a-item");if(contents[0].show(),this.disallowAccessToNextSections)for(var pastCurrentSection=!1,i=0;i<this.sections.length;i++)pastCurrentSection&&Element.removeClassName(this.sections[i],"allow"),this.sections[i].id==section.id&&(pastCurrentSection=!0)}},closeSection:function(section){$(section).removeClassName("active");var contents=Element.select(section,".a-item");contents[0].hide()},openNextSection:function(setAllow){for(section in this.sections){var nextIndex=parseInt(section)+1;if(this.sections[section].id==this.currentSection&&this.sections[nextIndex])return setAllow&&Element.addClassName(this.sections[nextIndex],"allow"),void this.openSection(this.sections[nextIndex])}},openPrevSection:function(setAllow){for(section in this.sections){var prevIndex=parseInt(section)-1;if(this.sections[section].id==this.currentSection&&this.sections[prevIndex])return setAllow&&Element.addClassName(this.sections[prevIndex],"allow"),void this.openSection(this.sections[prevIndex])}},closeExistingSection:function(){this.currentSection&&this.closeSection(this.currentSection)}};var Checkout=Class.create();Checkout.prototype={initialize:function(accordion,urls){this.accordion=accordion,this.progressUrl=urls.progress,this.reviewUrl=urls.review,this.saveMethodUrl=urls.saveMethod,this.failureUrl=urls.failure,this.billingForm=!1,this.shippingForm=!1,this.syncBillingShipping=!1,this.method="",this.payment="",this.loadWaiting=!1,this.steps=["login","billing","shipping","shipping_method","payment","review"],this.currentStep="billing",this.accordion.sections.each(function(section){Event.observe($(section).down(".step-title"),"click",this._onSectionClick.bindAsEventListener(this))}.bind(this)),this.accordion.disallowAccessToNextSections=!0},_onSectionClick:function(event){var section=$(Event.element(event).up(".section"));if(section.hasClassName("allow"))return Event.stop(event),this.gotoSection(section.readAttribute("id").replace("opc-",""),!1),!1},ajaxFailure:function(){location.href=encodeURI(this.failureUrl)},reloadProgressBlock:function(toStep){this.reloadStep(toStep),this.syncBillingShipping&&(this.syncBillingShipping=!1,this.reloadStep("shipping"))},reloadStep:function(prevStep){new Ajax.Updater(prevStep+"-progress-opcheckout",this.progressUrl,{method:"get",onFailure:this.ajaxFailure.bind(this),onComplete:function(){this.checkout.resetPreviousSteps()},parameters:prevStep?{prevStep:prevStep}:null})},reloadReviewBlock:function(){new Ajax.Updater("checkout-review-load",this.reviewUrl,{method:"get",onFailure:this.ajaxFailure.bind(this)})},_disableEnableAll:function(element,isDisabled){var descendants=element.descendants();for(var k in descendants)descendants[k].disabled=isDisabled;element.disabled=isDisabled},setLoadWaiting:function(step,keepDisabled){var container;if(step)this.loadWaiting&&this.setLoadWaiting(!1),container=$(step+"-buttons-container"),container.addClassName("disabled"),container.setStyle({opacity:.5}),this._disableEnableAll(container,!0),Element.show(step+"-please-wait");else if(this.loadWaiting){container=$(this.loadWaiting+"-buttons-container");var isDisabled=!!keepDisabled;isDisabled||(container.removeClassName("disabled"),container.setStyle({opacity:1})),this._disableEnableAll(container,isDisabled),Element.hide(this.loadWaiting+"-please-wait")}this.loadWaiting=step},gotoSection:function(section,reloadProgressBlock){reloadProgressBlock&&this.reloadProgressBlock(this.currentStep),this.currentStep=section;var sectionElement=$("opc-"+section);sectionElement.addClassName("allow"),this.accordion.openSection("opc-"+section),reloadProgressBlock||this.resetPreviousSteps()},resetPreviousSteps:function(){for(var stepIndex=this.steps.indexOf(this.currentStep),i=stepIndex;i<this.steps.length;i++){var nextStep=this.steps[i],progressDiv=nextStep+"-progress-opcheckout";$(progressDiv)&&($(progressDiv).select(".changelink").invoke("remove"),$(progressDiv).select("dt").invoke("removeClassName","complete"),$(progressDiv).select("dd.complete").invoke("remove"))}},changeSection:function(section){var changeStep=section.replace("opc-","");this.gotoSection(changeStep,!1)},setMethod:function(){if($("login:guest")&&$("login:guest").checked)this.method="guest",new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),parameters:{method:"guest"}}),Element.hide("register-customer-password"),this.gotoSection("billing",!0);else{if(!$("login:register")||!$("login:register").checked&&"hidden"!=$("login:register").type)return alert(Translator.translate("Please choose to register or to checkout as a guest").stripTags()),!1;this.method="register",new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),parameters:{method:"register"}}),Element.show("register-customer-password"),this.gotoSection("billing",!0)}document.body.fire("login:setMethod",{method:this.method})},setBilling:function(){$("billing:use_for_shipping_yes")&&$("billing:use_for_shipping_yes").checked?(shipping.syncWithBilling(),$("opc-shipping").addClassName("allow"),this.gotoSection("shipping_method",!0)):$("billing:use_for_shipping_no")&&$("billing:use_for_shipping_no").checked?($("shipping:same_as_billing").checked=!1,this.gotoSection("shipping",!0)):($("shipping:same_as_billing").checked=!0,this.gotoSection("shipping",!0))},setShipping:function(){this.gotoSection("shipping_method",!0)},setShippingMethod:function(){this.gotoSection("payment",!0)},setPayment:function(){this.gotoSection("review",!0)},setReview:function(){this.reloadProgressBlock()},back:function(){if(!this.loadWaiting){for(var stepIndex=this.steps.indexOf(this.currentStep),section=this.steps[--stepIndex],sectionElement=$("opc-"+section);null===sectionElement&&stepIndex>0;)--stepIndex,section=this.steps[stepIndex],sectionElement=$("opc-"+section);this.changeSection("opc-"+section)}},setStepResponse:function(response){return response.update_section&&$("checkout-"+response.update_section.name+"-load").update(response.update_section.html),response.allow_sections&&response.allow_sections.each(function(e){$("opc-"+e).addClassName("allow")}),response.duplicateBillingInfo&&(this.syncBillingShipping=!0,shipping.setSameAsBilling(!0)),response.goto_section?(this.gotoSection(response.goto_section,!0),!0):!!response.redirect&&(location.href=encodeURI(response.redirect),!0)}};var Billing=Class.create();Billing.prototype={initialize:function(form,addressUrl,saveUrl){this.form=form,$(this.form)&&$(this.form).observe("submit",function(event){this.save(),Event.stop(event)}.bind(this)),this.addressUrl=addressUrl,this.saveUrl=saveUrl,this.onAddressLoad=this.fillForm.bindAsEventListener(this),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},setAddress:function(addressId){addressId?new Ajax.Request(this.addressUrl+addressId,{method:"get",onSuccess:this.onAddressLoad,onFailure:checkout.ajaxFailure.bind(checkout)}):this.fillForm(!1)},newAddress:function(isNew){isNew?(this.resetSelectedAddress(),Element.show("billing-new-address-form")):Element.hide("billing-new-address-form")},resetSelectedAddress:function(){var selectElement=$("billing-address-select");selectElement&&(selectElement.value="")},fillForm:function(transport){var elementValues=transport.responseJSON||transport.responseText.evalJSON(!0)||{};transport||Object.keys(elementValues).length||this.resetSelectedAddress();var arrElements=Form.getElements(this.form);for(var elemIndex in arrElements)if(arrElements.hasOwnProperty(elemIndex)&&arrElements[elemIndex].id){var fieldName=arrElements[elemIndex].id.replace(/^billing:/,"");arrElements[elemIndex].value=elementValues[fieldName]?elementValues[fieldName]:"","country_id"==fieldName&&billingForm&&billingForm.elementChildLoad(arrElements[elemIndex])}},setUseForShipping:function(flag){$("shipping:same_as_billing").checked=flag},save:function(){if(0==checkout.loadWaiting){var validator=new Validation(this.form);validator.validate()&&(checkout.setLoadWaiting("billing"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))}},resetLoadWaiting:function(transport){checkout.setLoadWaiting(!1),document.body.fire("billing-request:completed",{transport:transport})},nextStep:function(transport){var response=transport.responseJSON||transport.responseText.evalJSON(!0)||{};if(response.error){if(Object.isString(response.message))alert(response.message.stripTags().toString());else{window.billingRegionUpdater&&billingRegionUpdater.update();var msg=response.message;Object.isArray(msg)&&alert(msg.join("\n")),alert(msg.stripTags().toString())}return!1}checkout.setStepResponse(response),payment&&payment.initWhatIsCvvListeners()}};var Shipping=Class.create();Shipping.prototype={initialize:function(form,addressUrl,saveUrl,methodsUrl){this.form=form,$(this.form)&&$(this.form).observe("submit",function(event){this.save(),Event.stop(event)}.bind(this)),this.addressUrl=addressUrl,this.saveUrl=saveUrl,this.methodsUrl=methodsUrl,this.onAddressLoad=this.fillForm.bindAsEventListener(this),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},setAddress:function(addressId){addressId?new Ajax.Request(this.addressUrl+addressId,{method:"get",onSuccess:this.onAddressLoad,onFailure:checkout.ajaxFailure.bind(checkout)}):this.fillForm(!1)},newAddress:function(isNew){isNew?(this.resetSelectedAddress(),Element.show("shipping-new-address-form")):Element.hide("shipping-new-address-form"),shipping.setSameAsBilling(!1)},resetSelectedAddress:function(){var selectElement=$("shipping-address-select");selectElement&&(selectElement.value="")},fillForm:function(transport){var elementValues=transport.responseJSON||transport.responseText.evalJSON(!0)||{};transport||Object.keys(elementValues).length||this.resetSelectedAddress();var arrElements=Form.getElements(this.form);for(var elemIndex in arrElements)if(arrElements.hasOwnProperty(elemIndex)&&arrElements[elemIndex].id){var fieldName=arrElements[elemIndex].id.replace(/^shipping:/,"");arrElements[elemIndex].value=elementValues[fieldName]?elementValues[fieldName]:"","country_id"==fieldName&&shippingForm&&shippingForm.elementChildLoad(arrElements[elemIndex])}},setSameAsBilling:function(flag){$("shipping:same_as_billing").checked=flag,flag&&this.syncWithBilling()},syncWithBilling:function(){if($("billing-address-select")&&this.newAddress(!$("billing-address-select").value),$("shipping:same_as_billing").checked=!0,$("billing-address-select")&&$("billing-address-select").value)$("shipping-address-select").value=$("billing-address-select").value;else{arrElements=Form.getElements(this.form);for(var elemIndex in arrElements)if(arrElements[elemIndex].id){var sourceField=$(arrElements[elemIndex].id.replace(/^shipping:/,"billing:"));sourceField&&(arrElements[elemIndex].value=sourceField.value)}shippingRegionUpdater.update(),$("shipping:region_id").value=$("billing:region_id").value,$("shipping:region").value=$("billing:region").value}},setRegionValue:function(){$("shipping:region").value=$("billing:region").value},save:function(){if(0==checkout.loadWaiting){var validator=new Validation(this.form);validator.validate()&&(checkout.setLoadWaiting("shipping"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))}},resetLoadWaiting:function(){checkout.setLoadWaiting(!1)},nextStep:function(transport){var response=transport.responseJSON||transport.responseText.evalJSON(!0)||{};if(response.error){if(Object.isString(response.message))alert(response.message.stripTags().toString());else{window.shippingRegionUpdater&&shippingRegionUpdater.update();var msg=response.message;Object.isArray(msg)&&alert(msg.join("\n")),alert(msg.stripTags().toString())}return!1}checkout.setStepResponse(response)}};var ShippingMethod=Class.create();ShippingMethod.prototype={initialize:function(form,saveUrl){this.form=form,$(this.form)&&$(this.form).observe("submit",function(event){this.save(),Event.stop(event)}.bind(this)),this.saveUrl=saveUrl,this.validator=new Validation(this.form),this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},validate:function(){var methods=document.getElementsByName("shipping_method");if(0==methods.length)return alert(Translator.translate("Your order cannot be completed at this time as there is no shipping methods available for it. Please make necessary changes in your shipping address.").stripTags()),!1;if(!this.validator.validate())return!1;for(var i=0;i<methods.length;i++)if(methods[i].checked)return!0;return alert(Translator.translate("Please specify shipping method.").stripTags()),!1},save:function(){0==checkout.loadWaiting&&this.validate()&&(checkout.setLoadWaiting("shipping-method"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))},resetLoadWaiting:function(transport){checkout.setLoadWaiting(!1)},nextStep:function(transport){var response=transport.responseJSON||transport.responseText.evalJSON(!0)||{};return response.error?(alert(response.message.stripTags().toString()),!1):(response.update_section&&$("checkout-"+response.update_section.name+"-load").update(response.update_section.html),payment.initWhatIsCvvListeners(),response.goto_section?(checkout.gotoSection(response.goto_section,!0),void checkout.reloadProgressBlock()):(response.payment_methods_html&&$("checkout-payment-method-load").update(response.payment_methods_html),void checkout.setShippingMethod()))}};var Payment=Class.create();Payment.prototype={beforeInitFunc:$H({}),afterInitFunc:$H({}),beforeValidateFunc:$H({}),afterValidateFunc:$H({}),initialize:function(form,saveUrl){this.form=form,this.saveUrl=saveUrl,this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},addBeforeInitFunction:function(code,func){this.beforeInitFunc.set(code,func)},beforeInit:function(){this.beforeInitFunc.each(function(init){init.value()})},init:function(){this.beforeInit();var elements=Form.getElements(this.form);$(this.form)&&$(this.form).observe("submit",function(event){this.save(),Event.stop(event)}.bind(this));for(var method=null,i=0;i<elements.length;i++)"payment[method]"==elements[i].name?elements[i].checked&&(method=elements[i].value):elements[i].disabled=!0,elements[i].setAttribute("autocomplete","off");method&&this.switchMethod(method),this.afterInit()},addAfterInitFunction:function(code,func){this.afterInitFunc.set(code,func)},afterInit:function(){this.afterInitFunc.each(function(init){init.value()})},switchMethod:function(method){this.currentMethod&&$("payment_form_"+this.currentMethod)&&(this.changeVisible(this.currentMethod,!0),$("payment_form_"+this.currentMethod).fire("payment-method:switched-off",{method_code:this.currentMethod})),$("payment_form_"+method)?(this.changeVisible(method,!1),$("payment_form_"+method).fire("payment-method:switched",{method_code:method})):document.body.fire("payment-method:switched",{method_code:method}),"free"==method&&quoteBaseGrandTotal>1e-4&&!($("use_reward_points")&&$("use_reward_points").checked||$("use_customer_balance")&&$("use_customer_balance").checked)&&$("p_method_"+method)&&($("p_method_"+method).checked=!1,$("dt_method_"+method)&&$("dt_method_"+method).hide(),$("dd_method_"+method)&&$("dd_method_"+method).hide()),method&&(this.lastUsedMethod=method),this.currentMethod=method},changeVisible:function(method,mode){var block="payment_form_"+method;[block+"_before",block,block+"_after"].each(function(el){element=$(el),element&&(element.style.display=mode?"none":"",element.select("input","select","textarea","button").each(function(field){field.disabled=mode}))})},addBeforeValidateFunction:function(code,func){this.beforeValidateFunc.set(code,func)},beforeValidate:function(){var validateResult=!0,hasValidation=!1;return this.beforeValidateFunc.each(function(validate){hasValidation=!0,0==validate.value()&&(validateResult=!1)}.bind(this)),hasValidation||(validateResult=!1),validateResult},validate:function(){var result=this.beforeValidate();if(result)return!0;var methods=document.getElementsByName("payment[method]");if(0==methods.length)return alert(Translator.translate("Your order cannot be completed at this time as there is no payment methods available for it.").stripTags()),!1;for(var i=0;i<methods.length;i++)if(methods[i].checked)return!0;return!!(result=this.afterValidate())||(alert(Translator.translate("Please specify payment method.").stripTags()),!1)},addAfterValidateFunction:function(code,func){this.afterValidateFunc.set(code,func)},afterValidate:function(){var validateResult=!0,hasValidation=!1;return this.afterValidateFunc.each(function(validate){hasValidation=!0,0==validate.value()&&(validateResult=!1)}.bind(this)),hasValidation||(validateResult=!1),validateResult},save:function(){if(0==checkout.loadWaiting){var validator=new Validation(this.form);this.validate()&&validator.validate()&&(checkout.setLoadWaiting("payment"),new Ajax.Request(this.saveUrl,{method:"post",onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)}))}},resetLoadWaiting:function(){checkout.setLoadWaiting(!1)},nextStep:function(transport){var response=transport.responseJSON||transport.responseText.evalJSON(!0)||{};if(response.error){if(response.fields){for(var fields=response.fields.split(","),i=0;i<fields.length;i++){var field=null;(field=$(fields[i]))&&Validation.ajaxError(field,response.error)}return}return void(Object.isString(response.message)?alert(response.message.stripTags().toString()):alert(response.error.stripTags().toString()))}checkout.setStepResponse(response)},initWhatIsCvvListeners:function(){$$(".cvv-what-is-this").each(function(element){Event.observe(element,"click",toggleToolTip)})}};var Review=Class.create();Review.prototype={initialize:function(saveUrl,successUrl,agreementsForm){this.saveUrl=saveUrl,this.successUrl=successUrl,this.agreementsForm=agreementsForm,this.onSave=this.nextStep.bindAsEventListener(this),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},save:function(){if(0==checkout.loadWaiting){checkout.setLoadWaiting("review");var params=Form.serialize(payment.form);this.agreementsForm&&(params+="&"+Form.serialize(this.agreementsForm)),params.save=!0,new Ajax.Request(this.saveUrl,{method:"post",parameters:params,onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout)})}},resetLoadWaiting:function(transport){checkout.setLoadWaiting(!1,this.isSuccess)},nextStep:function(transport){if(transport){var response=transport.responseJSON||transport.responseText.evalJSON(!0)||{};if(response.redirect)return this.isSuccess=!0,void(location.href=encodeURI(response.redirect));if(response.success)this.isSuccess=!0,location.href=encodeURI(this.successUrl);else{var msg=response.error_messages;Object.isArray(msg)&&(msg=msg.join("\n").stripTags().toString()),msg&&alert(msg)}response.update_section&&$("checkout-"+response.update_section.name+"-load").update(response.update_section.html),response.goto_section&&checkout.gotoSection(response.goto_section,!0)}},isSuccess:!1},Object.extend(Checkout.prototype,{reloadStep:function(prevStep){new Ajax.Updater(prevStep+"-progress-opcheckout",this.progressUrl,{method:"get",onFailure:this.ajaxFailure.bind(this),onComplete:function(){this.checkout.resetPreviousSteps();var opcProgressTeleporter=$$(".opc-progress-teleporter")[0];opcProgressTeleporter&&(opcProgressTeleporter.innerHTML=$$(".opc-progress")[0].innerHTML)},parameters:prevStep?{prevStep:prevStep}:null})},setLoadWaiting:function(step,keepDisabled){var container;if(step)this.loadWaiting&&this.setLoadWaiting(!1),container=$(step+"-buttons-container"),container.addClassName("disabled"),this._disableEnableAll(container,!0),Element.show(step+"-please-wait");else if(this.loadWaiting){container=$(this.loadWaiting+"-buttons-container");var isDisabled=!!keepDisabled;isDisabled||container.removeClassName("disabled"),this._disableEnableAll(container,isDisabled),Element.hide(this.loadWaiting+"-please-wait")}this.loadWaiting=step},gotoSection:function(section,reloadProgressBlock){reloadProgressBlock&&this.reloadProgressBlock(this.currentStep),this.currentStep=section;var sectionElement=$("opc-"+section);sectionElement.addClassName("allow"),this.accordion.openSection("opc-"+section),reloadProgressBlock||this.resetPreviousSteps(),document.viewport.getHeight()<=600&&Effect.ScrollTo(sectionElement,{duration:"0.2"})},resetPreviousSteps:function(){for(var stepIndex=this.steps.indexOf(this.currentStep),i=stepIndex;i<this.steps.length;i++){var nextStep=this.steps[i],progressDiv=nextStep+"-progress-opcheckout";$(progressDiv)&&($(progressDiv).select(".opc-progress_button").each(function(item){item.remove()}),$(progressDiv).select(".opc-progress_title").each(function(item){item.removeClassName("complete")}),$(progressDiv).select(".opc-progress_content.complete").each(function(item){item.update(Translator.translate("Pending"))}))}}}),Object.extend(Payment.prototype,{initWhatIsCvvListeners:function(){}});